name: Test Policy Definitions

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'KubeVela repository to clone'
        required: true
        default: 'oam-dev/kubevela'
      branch:
        description: 'Branch to checkout'
        required: true
        default: 'master'
  workflow_call:
    inputs:
      repository:
        description: 'KubeVela repository to clone'
        required: true
        type: string
        default: 'oam-dev/kubevela'
      branch:
        description: 'Branch to checkout'
        required: true
        type: string
        default: 'master'

jobs:
  test-policies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v5

      - name: Setup KubeVela Environment
        uses: ./.github/actions/setup-vela-environment
        with:
          repository: ${{ github.event.inputs.repository }}
          branch: ${{ github.event.inputs.branch }}

      - name: Run Policy E2E Tests
        run: |
          echo "Running E2E tests for policy definitions..."
          make test-e2e-policies \
            VELA_CLI=${{ github.workspace }}/kubevela-source/bin/vela \
            TESTDATA_PATH=${{ github.workspace }}/test/builtin-definition-example

      - name: Summary
        if: always()
        run: |
          echo "## Policy Definition Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.event.inputs.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installed Definitions" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get policydefinitions -n vela-system --no-headers | wc -l | xargs -I {} echo "Policy Definitions: {}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Applications" >> $GITHUB_STEP_SUMMARY
          echo "Tested applications from \`test/builtin-definition-example/policies/\`:" >> $GITHUB_STEP_SUMMARY
          ls -1 test/builtin-definition-example/policies/*.yaml | xargs -I {} basename {} | while read f; do echo "- $f"; done >> $GITHUB_STEP_SUMMARY

