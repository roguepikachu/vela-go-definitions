name: Test All Definitions

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'KubeVela repository to clone'
        required: true
        default: 'oam-dev/kubevela'
      branch:
        description: 'Branch to checkout'
        required: true
        default: 'master'

jobs:
  # Run all 4 definition type tests in parallel
  test-components:
    uses: ./.github/workflows/test-component-definitions.yaml
    with:
      repository: ${{ github.event.inputs.repository }}
      branch: ${{ github.event.inputs.branch }}

  test-traits:
    uses: ./.github/workflows/test-trait-definitions.yaml
    with:
      repository: ${{ github.event.inputs.repository }}
      branch: ${{ github.event.inputs.branch }}

  test-policies:
    uses: ./.github/workflows/test-policy-definitions.yaml
    with:
      repository: ${{ github.event.inputs.repository }}
      branch: ${{ github.event.inputs.branch }}

  test-workflowsteps:
    uses: ./.github/workflows/test-workflowstep-definitions.yaml
    with:
      repository: ${{ github.event.inputs.repository }}
      branch: ${{ github.event.inputs.branch }}

  # Summary job that runs after all tests complete
  summary:
    runs-on: ubuntu-latest
    needs: [test-components, test-traits, test-policies, test-workflowsteps]
    if: always()
    steps:
      - name: Generate Final Summary
        run: |
          echo "# Definition E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Definition Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Components | ${{ needs.test-components.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Traits | ${{ needs.test-traits.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Policies | ${{ needs.test-policies.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WorkflowSteps | ${{ needs.test-workflowsteps.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.event.inputs.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY

