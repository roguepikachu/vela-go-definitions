name: Run Component definition test

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository to clone'
        required: true
        default: 'oam-dev/kubevela'
      branch:
        description: 'Branch to checkout'
        required: true
        default: 'master'

jobs:
  run-component-def-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Set up Kubernetes (Kind)
        uses: helm/kind-action@v1
        with:
          cluster_name: vela-test
          wait: 120s

      - name: Verify Kubernetes cluster
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Download and install Vela CLI (latest release)
        run: |
          curl -fsSl https://kubevela.io/script/install.sh | bash
          vela version

      - name: Install KubeVela
        run: |
          vela install

      - name: Wait for KubeVela to be ready
        run: |
          echo "Waiting for KubeVela to be ready..."
          kubectl wait --for=condition=available --timeout=300s deployment/kubevela-vela-core -n vela-system || true
          kubectl get pods -n vela-system

      - name: Clone specified repository
        run: |
          echo "Cloning repository: ${{ github.event.inputs.repository }}"
          echo "Branch: ${{ github.event.inputs.branch }}"
          
          # Clone the repository
          git clone https://github.com/${{ github.event.inputs.repository }}.git kubevela-source
          cd kubevela-source
          
          # Fetch all branches
          echo "Fetching all branches..."
          git fetch --all
          
          # List available branches
          echo "Available branches:"
          git branch -r | head -20
          
          # Check if the branch exists
          if git show-ref --verify --quiet refs/remotes/origin/${{ github.event.inputs.branch }}; then
            echo "Branch ${{ github.event.inputs.branch }} found, checking out..."
            git checkout ${{ github.event.inputs.branch }}
          else
            echo "❌ Error: Branch '${{ github.event.inputs.branch }}' not found in repository"
            echo "Available branches matching pattern:"
            git branch -r | grep -i "${{ github.event.inputs.branch }}" || echo "No matching branches found"
            echo ""
            echo "All available branches:"
            git branch -r
            exit 1
          fi
          
          # Show current commit
          echo "Current commit:"
          git log -1 --oneline

      - name: Build Vela CLI from source
        working-directory: kubevela-source
        run: |
          echo "Building Vela CLI..."
          make vela-cli

      - name: Verify built CLI
        working-directory: kubevela-source
        run: |
          if [ -f bin/vela ]; then
            echo "Vela CLI built successfully!"
            ./bin/vela version
            ls -lh bin/vela
          else
            echo "Error: Vela CLI binary not found in bin/vela"
            find . -name "vela" -type f
            exit 1
          fi

      - name: List installed definitions before cleanup
        run: |
          echo "Listing installed component definitions..."
          kubectl get componentdefinitions -n vela-system

      - name: Uninstall built-in definitions
        run: |
          echo "Uninstalling built-in component definitions..."
          kubectl delete componentdefinitions --all -n vela-system || true
          kubectl delete traitdefinitions --all -n vela-system || true
          kubectl delete workflowstepdefinitions --all -n vela-system || true
          kubectl delete policydefinitions --all -n vela-system || true
          echo "Built-in definitions uninstalled"

      - name: List definitions from vela-definitions module
        run: |
          echo "Listing definitions from vela-definitions module..."
          kubevela-source/bin/vela def list-module vela-definitions

      - name: Install definitions from defkit
        run: |
          echo "Installing definitions from vela-definitions module..."
          kubevela-source/bin/vela def apply-module vela-definitions --conflict=overwrite
          echo "Definitions installed successfully"

      - name: Verify installed definitions
        run: |
          echo "Verifying installed definitions..."
          kubectl get componentdefinitions -n vela-system
          kubectl get traitdefinitions -n vela-system
          kubectl get workflowstepdefinitions -n vela-system
          kubectl get policydefinitions -n vela-system

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.event.inputs.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CLI Location:** kubevela-source/bin/vela" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Vela CLI built successfully" >> $GITHUB_STEP_SUMMARY
          echo "✅ Built-in definitions uninstalled" >> $GITHUB_STEP_SUMMARY
          echo "✅ Definitions from vela-definitions module installed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installed Definitions" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get componentdefinitions -n vela-system --no-headers | wc -l | xargs -I {} echo "Component Definitions: {}" >> $GITHUB_STEP_SUMMARY
          kubectl get traitdefinitions -n vela-system --no-headers | wc -l | xargs -I {} echo "Trait Definitions: {}" >> $GITHUB_STEP_SUMMARY
          kubectl get workflowstepdefinitions -n vela-system --no-headers | wc -l | xargs -I {} echo "WorkflowStep Definitions: {}" >> $GITHUB_STEP_SUMMARY
          kubectl get policydefinitions -n vela-system --no-headers | wc -l | xargs -I {} echo "Policy Definitions: {}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

